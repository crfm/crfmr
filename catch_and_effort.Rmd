---
title: "Estimation of catch and effort"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(stringr)
library(knitr)
```

# Preamble

The main objective of this exercise is to demonstrate how total catch and total effort can be estimated in R given sample based fishery-surveys data.

There are three principal equations in fisheries science needed to solve the whole riddle:

Catch = Fishing mortality x Biomass

Fishing mortality = catchability x Effort

Catch = CPUE x Effort

Here we will only deal with the last one. It is the most important one, because if one gets that one wrong, the rest of the riddle, which requires additional assumption, will become blatantly wrong.

In a sample based fishery effort is derived from:

* A census-based __Frame Survey__ providing the raising factor __F__ that expresses the total number of boats
* An __Active Days Survey__ to determine the time raising factor __A__ expressing number of days with fishing activities
* A sample-based __Boat Activity Survey__ to determine the __BAC__ (Boat Activity Coefficient) expressing the probability that any boat will be active on any given day.

Effort = (Boat Activity) x (Total boats) x (Active days)

or 

Effort = BAC x F x A

Overall cpue is derived from:

* A sample-based __Landing Survey__ to determine sample mean __CPUE__

Hence the generic formula to estimate catch is:

Catch = CPUE x Effort 

or expressed fully:

Catch = CPUE x BAC x F x A

In general these variables are first estimated by each strata and then aggregated as needed.

# The data

The following case example is based on data used to illustrate the operation of the [ARTFISH software](http://www.fao.org/fishery/topic/16081/en). The data has been imported into an [Excel workbook](http://www.hafro.is/~einarhj/crfmr/data-raw/artfish.xlsx).

The basic strata system in this case example is:

* Month: Here we only have one months of data, but then this is just a case example.
* Area: Two areas, Northwest (nw) with two sites sampled and Southeast (se) with three sites sampled. There are then additional sites that are not sampled but the number of boats are known from a frame survey.
* Gear: Two gear categories are in the case example, hook and line and traps.

When calculating catch and effort one normally does this first on the strata basis. Given that we only have one month of data we will estimate 1 month x 2 areas x 2 gear categories of catches and effort (I.e. a total of 4 sets of estimates). These statistics form the basis upon which statistics on a more aggregated level are then calculated.

### Downloading the data

If you have a "data-raw" directory in you current R working directory one can download the workbook by:
```{r, eval = FALSE}
download.file(url = "http://www.hafro.is/~einarhj/crfmr/data-raw/artfish.xlsx",
              destfile = "data-raw/artfish.xlsx",
              mode = "wb")
```

### Tidying the data

... explanation of the tidy code pending

```{r}
f <- "data-raw/artfish.xlsx"
site <- 
  read_excel(f, sheet = "site")
frame.survey <- 
  read_excel(f, sheet = "frame_survey") %>% 
  gather(key = gear, value = total.boat, -c(area, site))
active.days <- 
  read_excel(f, sheet = "active_days")
boat.activity.nw <- 
  read_excel(f, sheet = "boat_activity", skip = 1) %>% 
  slice(1:4) %>% 
  gather(key = date, value = value, -c(site, gear)) %>% 
  separate(value, c("active", "sampled"), convert = TRUE) %>% 
  mutate(date = ymd(date))
boat.activity.se <- 
  read_excel(f, sheet = "boat_activity", skip = 7) %>% 
  gather(key = date, value = value, -c(site, gear)) %>% 
  separate(value, c("active", "sampled"), convert = TRUE) %>% 
  mutate(date = ymd(date))
boat.activity <- 
  bind_rows(boat.activity.nw, boat.activity.se) %>% 
  filter(!is.na(gear))
catch <- read_excel(f, "catch_2004_january")
tr <- 
  catch %>% 
  filter(gear %in% "trap")
i <- nrow(tr)/3
trip1 <-
  tr %>% 
  mutate(variable = rep(c("day", "duration", "total"), i)) %>% 
  select(tid, variable, misc) %>% 
  spread(variable, misc)
hl <-
  catch %>% 
  filter(!gear %in% "trap")
i <- nrow(hl)/2
trip2 <-
  hl %>% 
  mutate(variable = rep(c("day", "total"), i)) %>% 
  select(tid, variable, misc) %>% 
  spread(variable, misc) %>% 
  mutate(duration = 1)
trip <- 
  bind_rows(trip1, trip2) %>% 
  mutate(date = ymd(paste0("2004-1-", day))) %>% 
  select(tid, date, duration) %>% 
  left_join(catch %>% select(tid, site, gear) %>% distinct()) %>%
  select(tid, date, site, gear, duration)
catch <-
  catch %>% 
  select(tid, species, wt, no, price)
```

# Calculations

## Boat activity

The boat activity is stored in the boat.activity table. It has five columns:

* __site__: The name of the landing site
* __gear__: The name of the gear
* __date__: Date of sampling
* __sampled__: Number of boats sampled
* __active__: Number of boats that were active

The strata area are is not stored in boat activity table but can be obtained from the `site` dataframe and merged to the table via `left_join`-function. Once done we can set the strata-grouping using the `group_by`-function and calculate various statistics. The statistics of primary interest is the boat activity coefficient (bac), which basically is the probability that a boat within a strata has gone fishing. The simplest way is to calculate the mean from the raw observations. And since we have the mean we can also calculate various additional statistic that represent the variability in the data.

```{r}
bac <-
  boat.activity %>% 
  left_join(site) %>% 
  mutate(month = month(date)) %>% 
  group_by(month, area, gear) %>% 
  summarise(n_sites = n_distinct(site),
            n_days = n_distinct(date),
            active_s = sum(active),
            sampled_s = sum(sampled),
            n = n(),
            bac_m = mean(active/sampled),
            se = sd(active/sampled)/sqrt(n),
            cv = se/bac_m) %>% 
  ungroup() %>% 
  mutate(bac_lower = bac_m - qt(.975, df = n - 1) * se,
         bac_upper = bac_m + qt(.975, df = n - 1) * se) %>% 
  ungroup() 
bac %>% 
  knitr::kable(digits = 3)
```

## Estimation of total effort

Besides BAC we need to know the total number of boats within each strata, such data normally coming from a frame survey. The frame survey data has four columns:

* __site__: The name of the landing site
* __area__: The name of the strata area for the site
* __gear__: The name of the gear
* __total.boat__: The number of boats

We obtain the sum of the boats for the strata by simply doing:
```{r}
fs <- 
  frame.survey %>% 
  group_by(area, gear) %>% 
  summarise(total.boats = sum(total.boat))
```

The number of active days by the strata is stored in the `active.days`-table. We simply merge the three tables containing the bac, total number of boats boats and active days in the month, using the `left_join`-function and once done we can calculate the total effort given the equation above:
```{r}
effort <-
  bac %>%
  select(month, area, gear, bac = bac_m) %>% 
  left_join(fs) %>% 
  left_join(active.days %>% select(area, gear, days)) %>% 
  mutate(effort = bac * total.boats * days)
kable(effort, digits = 2)
```

## Calculation of CPUE

In order to calculate the catch per unit effort we need merge information from the trip and the catch tables. The trip table has the following columns:

* __tid__: A unique trip identifier
* __date__: The date the trip was sampled
* __site__: The landing site name
* __gear__: The name of the gear used
* __duration__: The number of days fishing

The catch table has the following columns:

* __tid__: A trip identifier (links to the trip table tid)
* __species__: The name of the species sampled
* __wt__: The weight of the sample (here in kg)
* __no__: The number of fish sampled
* __price__: The selling price

Here we calculate the total cpue per trip, ignoring the species. We hence need to sum the catch of all the species in each trip before we join the data with the trip information. Once done we calculate the cpue for each trip, join the data to the site table (to get the strata area) and then calculate the summary statistic for each strata:

```{r}
cpue <-
  catch %>% 
  group_by(tid) %>%
  summarise(catch = sum(wt)) %>% 
  ungroup() %>% 
  left_join(trip) %>% 
  mutate(month = month(date),
         cpue = catch/duration) %>% 
  left_join(site) %>% 
  group_by(month, area, gear) %>% 
  summarise(n = n(),
            catch = sum(catch),
            cpue_m = mean(cpue),
            se = sd(cpue)/sqrt(n),
            cv = se/cpue_m) %>% 
  ungroup() %>% 
  mutate(cpue_lower = cpue_m - qt(.975, df = n - 1) * se,
         cpue_upper = cpue_m + qt(.975, df = n - 1) * se)
cpue %>% kable(digits = 3)
```

## Calculation of landings by strata

We have now have the catch and effort by strata in two tables (cpue and effort) which now can be merged and then landings by strata are simple to calculate:
```{r}
landings <-
  cpue %>% 
  select(month, area, gear, cpue = cpue_m) %>% 
  left_join(effort) %>% 
  mutate(landings = cpue * effort)
kable(landings, digits = 2)
```

# Recapitulation

The bare minimum coding is given below and is less than 40 lines. If one had more months of data, more gears and more landings site one could still use the same code. Actually with only a minor changes in the code one could calculate effort and landing statistics for multiple years.

```{r}
bac <-
  boat.activity %>% 
  left_join(site) %>% 
  mutate(month = month(date)) %>% 
  group_by(month, area, gear) %>% 
  summarise(bac = mean(active/sampled)) %>% 
  ungroup()
fs <- 
  frame.survey %>% 
  group_by(area, gear) %>% 
  summarise(total.boats = sum(total.boat)) %>% 
  ungroup()
effort <-
  bac %>%
  left_join(fs) %>% 
  left_join(active.days %>% select(area, gear, days)) %>% 
  mutate(effort = bac * total.boats * days)
cpue <-
  catch %>% 
  group_by(tid) %>%
  summarise(catch = sum(wt)) %>% 
  ungroup() %>% 
  left_join(trip) %>% 
  mutate(month = month(date),
         cpue = catch/duration) %>% 
  left_join(site) %>% 
  group_by(month, area, gear) %>% 
  summarise(cpue = mean(cpue)) %>% 
  ungroup()
landings <-
  cpue %>% 
  left_join(effort) %>% 
  mutate(landings = cpue * effort)
```

## Aggregated statistics

Calculation of more aggregated statistics can now be done based on the above calculation.

#### By month and area

```{r}
landings %>% 
  group_by(month, area) %>% 
  summarise(effort = sum(effort),
            landings = sum(landings)) %>% 
  kable(digits = 0)
```

#### By month and gear

```{r}
landings %>% 
  group_by(month, gear) %>% 
  summarise(effort = sum(effort),
            landings = sum(landings)) %>% 
  kable(digits = 0)
```

#### By month

```{r}
landings %>% 
  group_by(month) %>% 
  summarise(effort = sum(effort),
            landings = sum(landings)) %>% 
  kable(digits = 0)
```

#### By year

Well if we had more months we would be doing:

```{r}
landings %>% 
  summarise(effort = sum(effort),
            landings = sum(landings)) %>% 
  kable(digits = 0)
```

# On accuracy level

... need to add text

```{r}
ba <-
  boat.activity %>% 
  left_join(site) %>% 
  group_by(area, gear) %>% 
  summarise(n.bac = sum(sampled))
tr <-
  trip %>%
  left_join(site) %>% 
  group_by(area, gear) %>% 
  summarise(n.cat = n())
frame.survey %>% 
  group_by(area, gear) %>%
  summarise(boats = sum(total.boat)) %>% 
  left_join(active.days %>% select(area, gear, days)) %>% 
  mutate(N = boats * days) %>% 
  left_join(ba) %>% 
  left_join(tr) %>% 
  mutate(bac_accuracy_level = round((1 - 1.96 * 0.5/sqrt(n.bac) * sqrt(1 - n.bac/N)) * 100, 3),
         cat_accuracy_level = round((1 - 1.96 * sqrt((2 * N - 1)/(6 * (N - 1)) - 1/4) / sqrt(n.cat) * sqrt(1 - n.cat/N)) * 100, 3)) %>% 
  kable()
```


```{r, eval = FALSE, echo = FALSE}
# Leftovers
accuracy_concave <- function(n, N) {
  if(N >= 1000) {
    z <- 1.96
    s_concave = 0.5
    x <- 1 - z * s_concave/sqrt(n) * sqrt(1 - n/N)
    return(x)
  } else {
    print("not implemented yet for small populations")
  }
}



normalize <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}

x <- c(0:10) 
x %>% normalize()
x %>% normalize() %>% mean()



total.boats <-
  frame.survey %>% 
  group_by(strata, gear) %>% 
  summarise(no.boats = sum(total.boat))
bac <-
  boat.activity %>% 
  mutate(month = month(date)) %>% 
  left_join(frame.survey %>% select(site, strata)) %>% 
  group_by(strata, month, gear) %>% 
  summarise(bac = mean(active/sampled),
            n.sampled = sum(sampled),
            n.active = sum(active))
effort <-
  bac %>%
  left_join(active.days %>% select(-boats)) %>% 
  left_join(total.boats) %>% 
  mutate(effort = bac * days * no.boats)
effort %>% knitr::kable(digits = 2)
```

